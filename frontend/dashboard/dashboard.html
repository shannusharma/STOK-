<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Sharp" rel="stylesheet">
    <link rel="stylesheet" href="ui.css">
    <title>Stock Predictor Dashboard</title>
</head>
<body>
    <div class="container">
        <!-- ========== SIDEBAR ========== -->
        <aside>
            <div class="toggle">
                <div class="logo">
                    <img src="images.png" alt="Logo">
                    <h2>Markstro <span class="danger">Prediction</span></h2>
                </div>
                <div class="close" id="close-btn">
                    <span class="material-icons-sharp">close</span>
                </div>
            </div>

            <!-- SIDEBAR NAVIGATION -->
            <div class="sidebar">
                <a href="#" data-page="dashboard" class="nav-link active">
                    <span class="material-icons-sharp">dashboard</span>
                    <h3>Dashboard</h3>
                </a>
                <a href="#" data-page="portfolio" class="nav-link">
                    <span class="material-icons-sharp">inventory</span>
                    <h3>Portfolio</h3>
                </a>
                <a href="#" data-page="predictions" class="nav-link">
                    <span class="material-icons-sharp">insights</span>
                    <h3>Predictions</h3>
                </a>
                <a href="#" data-page="history" class="nav-link">
                    <span class="material-icons-sharp">history</span>
                    <h3>History</h3>
                </a>
                <a href="#" data-page="favorites" class="nav-link">
                    <span class="material-icons-sharp">favorite</span>
                    <h3>Favorites</h3>
                </a>
                <a href="#" data-page="news" class="nav-link">
                    <span class="material-icons-sharp">newspaper</span>
                    <h3>News</h3>
                </a>
                <a href="#" data-page="messages" class="nav-link">
                    <span class="material-icons-sharp">mail</span>
                    <h3>Messages</h3>
                </a>
                <a href="#" data-page="settings" class="nav-link">
                    <span class="material-icons-sharp">settings</span>
                    <h3>Settings</h3>
                </a>
                <a href="#" data-page="help" class="nav-link">
                    <span class="material-icons-sharp">help</span>
                    <h3>Help</h3>
                </a>
                <a href="#" onclick="logout()">
                    <span class="material-icons-sharp">logout</span>
                    <h3>Logout</h3>
                </a>
            </div>
        </aside>
        <!-- ========== END OF SIDEBAR ========== -->

        <!-- ========== MAIN CONTENT ========== -->
        <main id="main-content">
            <!-- Content will be dynamically loaded here -->
        </main>
    </div>

    <!-- ========== STOCK DETAIL MODAL ========== -->
    <div id="stock-detail-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-stock-name">Stock Name</h2>
                <span class="close-modal" onclick="closeStockDetail()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="stock-info-row">
                    <div class="info-item">
                        <small>Current Price</small>
                        <h3 id="modal-current-price">$0.00</h3>
                    </div>
                    <div class="info-item">
                        <small>Change</small>
                        <h3 id="modal-change" class="success-text">+0.00%</h3>
                    </div>
                    <div class="info-item">
                        <small>Open</small>
                        <h3 id="modal-open">$0.00</h3>
                    </div>
                    <div class="info-item">
                        <small>High</small>
                        <h3 id="modal-high">$0.00</h3>
                    </div>
                    <div class="info-item">
                        <small>Low</small>
                        <h3 id="modal-low">$0.00</h3>
                    </div>
                    <div class="info-item">
                        <small>Volume</small>
                        <h3 id="modal-volume">0</h3>
                    </div>
                </div>
                
                <!-- Chart Type Buttons -->
                <div class="chart-controls">
                    <button class="chart-btn active" onclick="switchChartType('candlestick')">Candlestick</button>
                    <button class="chart-btn" onclick="switchChartType('line')">Line</button>
                    <button class="chart-btn" onclick="switchChartType('area')">Area</button>
                    <button class="chart-btn" onclick="switchChartType('bar')">Volume</button>
                </div>
                
                <!-- Chart Canvas -->
                <div class="chart-wrapper">
                    <canvas id="modal-chart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Load Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <script>
        // ========== PAGE CONTENT TEMPLATES ==========
        const pages = {
            dashboard: `
                <div class="top-section">
                    <div class="search_div">
                        <span class="material-icons-sharp">search</span>
                        <input type="search" id="stock-search-input" placeholder="Search stocks, news, predictions..." onkeypress="handleSearchEnter(event)">
                    </div>
                    <div class="date">
                        <input type="date" id="date-input">
                    </div>
                </div>

                <h1>Dashboard</h1>

                <div class="market-sentiment">
                    <div class="sentiment-card bullish" id="sensex-card" onclick="openStockDetail('SENSEX')" style="cursor: pointer;">
                        <div class="icon-wrapper">
                            <span class="material-icons-sharp">trending_up</span>
                        </div>
                        <div class="content">
                            <h3>SENSEX</h3>
                            <h2 id="sensex-price" class="loading-pulse">Loading...</h2>
                            <small class="success-text" id="sensex-change">from last week</small>
                        </div>
                    </div>
                    <div class="sentiment-card bullish" id="nifty-card" onclick="openStockDetail('NIFTY50')" style="cursor: pointer;">
                        <div class="icon-wrapper">
                            <span class="material-icons-sharp">trending_up</span>
                        </div>
                        <div class="content">
                            <h3>NIFTY 50</h3>
                            <h2 id="nifty-price" class="loading-pulse">Loading...</h2>
                            <small class="success-text" id="nifty-change">from last week</small>
                        </div>
                    </div>
                </div>

                <div class="charts-section">
                    <div class="chart-card">
                        <h3>Stock Performance</h3>
                        <canvas id="stockPerformanceChart"></canvas>
                       
                    </div>
                    <div class="chart-card">
                        <h3>Market Trends</h3>
                        <canvas id="marketTrendsChart"></canvas>

                    </div>
                    <div class="chart-card">
                        <h3>Portfolio Overview</h3>
                        <canvas id="portfolioChart"></canvas>
                    </div>
                </div>
            `,

            portfolio: `
                <h1>Portfolio</h1>
                <p class="text-muted">View and manage your stock portfolio</p>

                <div class="stocks-grid">
                    <div class="stock-card" onclick="openStockDetail('AAPL')" style="cursor: pointer;">
                        <div class="stock-header">
                            <h3>AAPL</h3>
                            <span class="success-text">+2.5%</span>
                        </div>
                        <h2>$185.50</h2>
                        <p class="text-muted">Apple Inc.</p>
                        <div class="stock-chart-mini">
                            <span class="material-icons-sharp">show_chart</span>
                        </div>
                    </div>
                    <div class="stock-card" onclick="openStockDetail('GOOGL')" style="cursor: pointer;">
                        <div class="stock-header">
                            <h3>GOOGL</h3>
                            <span class="success-text">+1.8%</span>
                        </div>
                        <h2>$148.20</h2>
                        <p class="text-muted">Alphabet Inc.</p>
                        <div class="stock-chart-mini">
                            <span class="material-icons-sharp">show_chart</span>
                        </div>
                    </div>
                    <div class="stock-card" onclick="openStockDetail('MSFT')" style="cursor: pointer;">
                        <div class="stock-header">
                            <h3>MSFT</h3>
                            <span class="danger-text">-0.5%</span>
                        </div>
                        <h2>$380.15</h2>
                        <p class="text-muted">Microsoft Corp.</p>
                        <div class="stock-chart-mini">
                            <span class="material-icons-sharp">show_chart</span>
                        </div>
                    </div>
                    <div class="stock-card" onclick="openStockDetail('TSLA')" style="cursor: pointer;">
                        <div class="stock-header">
                            <h3>TSLA</h3>
                            <span class="success-text">+3.2%</span>
                        </div>
                        <h2>$242.80</h2>
                        <p class="text-muted">Tesla Inc.</p>
                        <div class="stock-chart-mini">
                            <span class="material-icons-sharp">show_chart</span>
                        </div>
                    </div>
                    <div class="stock-card" onclick="openStockDetail('AMZN')" style="cursor: pointer;">
                        <div class="stock-header">
                            <h3>AMZN</h3>
                            <span class="success-text">+1.5%</span>
                        </div>
                        <h2>$178.90</h2>
                        <p class="text-muted">Amazon.com Inc.</p>
                        <div class="stock-chart-mini">
                            <span class="material-icons-sharp">show_chart</span>
                        </div>
                    </div>
                    <div class="stock-card" onclick="openStockDetail('NVDA')" style="cursor: pointer;">
                        <div class="stock-header">
                            <h3>NVDA</h3>
                            <span class="success-text">+4.8%</span>
                        </div>
                        <h2>$495.30</h2>
                        <p class="text-muted">NVIDIA Corp.</p>
                        <div class="stock-chart-mini">
                            <span class="material-icons-sharp">show_chart</span>
                        </div>
                    </div>
                </div>
            `,

            predictions: `
                <h1>Predictions</h1>
                <p class="text-muted"> stock market predictions</p>

                <div class="predictions-grid">
                    <div class="prediction-card bullish-prediction">
                        <div class="prediction-header">
                           
                            <span class="badge success">Bullish</span>
                        </div>
                        <div class="prediction-details">
                            <p><strong>Current:</strong> $185.50</p>
                            <p><strong>Predicted:</strong> $195.20</p>
                            <p><strong>Confidence:</strong> 87%</p>
                            <p class="success-text">+5.2% expected growth</p>
                        </div>
                    </div>
                    <div class="prediction-card bearish-prediction">
                        <div class="prediction-header">
                            
                            <span class="badge danger">Bearish</span>
                        </div>
                        <div class="prediction-details">
                            <p><strong>Current:</strong> $242.80</p>
                            <p><strong>Predicted:</strong> $230.50</p>
                            <p><strong>Confidence:</strong> 73%</p>
                            <p class="danger-text">-5.1% expected decline</p>
                        </div>
                    </div>
                    <div class="prediction-card bullish-prediction">
                        <div class="prediction-header">
                            
                            <span class="badge success">Bullish</span>
                        </div>
                        <div class="prediction-details">
                            <p><strong>Current:</strong> $495.30</p>
                            <p><strong>Predicted:</strong> $520.80</p>
                            <p><strong>Confidence:</strong> 91%</p>
                            <p class="success-text">+5.1% expected growth</p>
                        </div>
                    </div>
                </div>
            `,

            history: `
                <h1>History</h1>
                <p class="text-muted">Your trading history and past transactions</p>

                <div class="history-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Stock</th>
                                <th>Type</th>
                                <th>Quantity</th>
                                <th>Price</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 2rem; color: var(--color-dark-variant);">No trading history available</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `,

            favorites: `
                <h1>Favorites</h1>
                <p class="text-muted">Your favorite stocks and watchlist</p>

                <div class="favorites-grid">
                    <div class="favorite-card" onclick="openStockDetail('AAPL')" style="cursor: pointer;">
                        <span class="material-icons-sharp favorite-icon">star</span>
                        <h3>AAPL</h3>
                        <span class="success-text">+2.5%</span>
                    </div>
                    <div class="favorite-card" onclick="openStockDetail('NVDA')" style="cursor: pointer;">
                        <span class="material-icons-sharp favorite-icon">star</span>
                        <h3>NVDA</h3>
                        <span class="success-text">+4.8%</span>
                    </div>
                    <div class="favorite-card" onclick="openStockDetail('GOOGL')" style="cursor: pointer;">
                        <span class="material-icons-sharp favorite-icon">star</span>
                        <h3>GOOGL</h3>
                        <span class="success-text">+1.8%</span>
                    </div>
                </div>
            `,

           news: `
    <h1>Market News Hub</h1>
    <p class="text-muted">Latest news from multiple trusted sources</p>

    <div class="news-sources">
        <button class="source-btn active" onclick="changeSource('all')" data-source="all">
            <span class="material-icons-sharp">dashboard</span>
            All Sources
        </button>
        <button class="source-btn" onclick="changeSource('cnbc')" data-source="cnbc">
            <span class="material-icons-sharp">newspaper</span>
            CNBC TV18
        </button>
        <button class="source-btn" onclick="changeSource('moneycontrol')" data-source="moneycontrol">
            <span class="material-icons-sharp">attach_money</span>
            MoneyControl
        </button>
        <button class="source-btn" onclick="changeSource('economictimes')" data-source="economictimes">
            <span class="material-icons-sharp">trending_up</span>
            Economic Times
        </button>
        <button class="source-btn" onclick="changeSource('research360')" data-source="research360">
            <span class="material-icons-sharp">analytics</span>
            Research360
        </button>
    </div>

    <div class="news-filter">
        <button class="filter-btn active" onclick="filterNews('all')">All News</button>
        <button class="filter-btn" onclick="filterNews('market')">Market</button>
        <button class="filter-btn" onclick="filterNews('stock')">Stocks</button>
        <button class="filter-btn" onclick="filterNews('economy')">Economy</button>
    </div>

    <div class="auto-refresh-info">
        <span class="material-icons-sharp">autorenew</span>
        <span>Auto-refreshing every 5 minutes</span>
        <span id="last-update">Last updated: Just now</span>
    </div>

    <div id="news-loading" class="loading-spinner">
        <span class="material-icons-sharp rotating">refresh</span>
        <p>Loading news from all sources...</p>
    </div>

    <div class="news-list" id="news-messages-list">
        <!-- News will be loaded here -->
    </div>

    <div class="news-footer">
        <button class="refresh-btn" onclick="manualRefresh()">
            <span class="material-icons-sharp">refresh</span>
            Refresh Now
        </button>
        <button class="toggle-auto-refresh" onclick="toggleAutoRefresh()">
            <span class="material-icons-sharp">pause</span>
            <span id="auto-refresh-text">Pause Auto-Refresh</span>
        </button>
    </div>
`,

         messages: `
    <h1>Messages & Notifications</h1>
    <p class="text-muted">Important updates from the administrator</p>

    <div class="messages-list">
        <div class="message-card unread">
            <span class="material-icons-sharp">notifications_active</span>
            <div class="message-content">
                <h3>Welcome to Markstro Prediction Dashboard!</h3>
                <p>Your account has been successfully activated. Start exploring market predictions and portfolio management tools.</p>
                <small>2 hours ago • Admin</small>
            </div>
        </div>
        <div class="message-card unread">
            <span class="material-icons-sharp">info</span>
            <div class="message-content">
                <h3>New Feature: Multi-Source News Feed</h3>
                <p>Check out our new News section with real-time updates from CNBC TV18, MoneyControl, Economic Times, and Research360!</p>
                <small>5 hours ago • System</small>
            </div>
        </div>
        <div class="message-card">
            <span class="material-icons-sharp">campaign</span>
            <div class="message-content">
                <h3>Market Alert: High Volatility Expected</h3>
                <p>Due to upcoming economic policy announcements, expect increased market volatility this week. Review your portfolio accordingly.</p>
                <small>1 day ago • Admin</small>
            </div>
        </div>
        <div class="message-card">
            <span class="material-icons-sharp">trending_up</span>
            <div class="message-content">
                <h3>Portfolio Performance Update</h3>
                <p>Your portfolio is up 3.2% this week. Great job maintaining a diversified investment strategy!</p>
                <small>2 days ago • System</small>
            </div>
        </div>
        <div class="message-card">
            <span class="material-icons-sharp">security</span>
            <div class="message-content">
                <h3>Security Update</h3>
                <p>We've enhanced our security features. Please review your account settings and enable two-factor authentication.</p>
                <small>3 days ago • Admin</small>
            </div>
        </div>
        <div class="message-card">
            <span class="material-icons-sharp">school</span>
            <div class="message-content">
                <h3>New Tutorial Available</h3>
                <p>Learn how to use our AI-powered prediction tools. Check the Help section for video tutorials.</p>
                <small>5 days ago • System</small>
            </div>
        </div>
    </div>

    <div class="admin-note">
        <span class="material-icons-sharp">info</span>
        <p>These messages are sent by the administrator. You cannot reply to or create messages here.</p>
    </div>
`,


            settings: `
                <div class="settings-header">
                    <h1>Settings</h1>
                    <p class="text-muted">Customize your dashboard appearance and preferences</p>
                </div>

                <div class="settings-section">
                    <h2>Appearance</h2>
                    <div class="theme-cards">
                        <div class="theme-card" data-theme="light">
                            <div class="theme-preview light-preview">
                                <div class="preview-sidebar"></div>
                                <div class="preview-content">
                                    <div class="preview-header"></div>
                                    <div class="preview-card"></div>
                                    <div class="preview-card"></div>
                                </div>
                            </div>
                            <div class="theme-info">
                                <div class="theme-icon">
                                    <span class="material-icons-sharp">light_mode</span>
                                </div>
                                <div class="theme-details">
                                    <h3>Light Mode</h3>
                                    <p>Bright and clean interface</p>
                                </div>
                                <div class="theme-check" id="light-check">
                                    <span class="material-icons-sharp">check_circle</span>
                                </div>
                            </div>
                        </div>
                        <div class="theme-card" data-theme="dark">
                            <div class="theme-preview dark-preview">
                                <div class="preview-sidebar"></div>
                                <div class="preview-content">
                                    <div class="preview-header"></div>
                                    <div class="preview-card"></div>
                                    <div class="preview-card"></div>
                                </div>
                            </div>
                            <div class="theme-info">
                                <div class="theme-icon">
                                    <span class="material-icons-sharp">dark_mode</span>
                                </div>
                                <div class="theme-details">
                                    <h3>Dark Mode</h3>
                                    <p>Easy on the eyes</p>
                                </div>
                                <div class="theme-check" id="dark-check">
                                    <span class="material-icons-sharp">check_circle</span>
                                </div>
                            </div>
                        </div>
                        <div class="theme-card" data-theme="default">
                            <div class="theme-preview default-preview">
                                <div class="preview-sidebar"></div>
                                <div class="preview-content">
                                    <div class="preview-header"></div>
                                    <div class="preview-card"></div>
                                    <div class="preview-card"></div>
                                </div>
                            </div>
                            <div class="theme-info">
                                <div class="theme-icon">
                                    <span class="material-icons-sharp">brightness_auto</span>
                                </div>
                                <div class="theme-details">
                                    <h3>Default Mode</h3>
                                    <p>Auto system preference</p>
                                </div>
                                <div class="theme-check" id="default-check">
                                    <span class="material-icons-sharp">check_circle</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <h2>Notifications</h2>
                    <div class="setting-item">
                        <div class="setting-info">
                            <h3>Price Alerts</h3>
                            <p>Get notified when prices hit targets</p>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <div class="setting-info">
                            <h3>News Updates</h3>
                            <p>Receive latest market news</p>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
            `,

            help: `
                <h1>Help Center</h1>
                <p class="text-muted">Get help and support</p>

                <div class="help-grid">
                    <div class="help-card">
                        <span class="material-icons-sharp">school</span>
                        <h3>Getting Started</h3>
                        <p>Learn the basics of using the dashboard</p>
                    </div>
                    <div class="help-card">
                        <span class="material-icons-sharp">support_agent</span>
                        <h3>Contact Support</h3>
                        <p>Reach out to our support team</p>
                    </div>
                    <div class="help-card">
                        <span class="material-icons-sharp">description</span>
                        <h3>Documentation</h3>
                        <p>Read detailed guides and tutorials</p>
                    </div>
                    <div class="help-card">
                        <span class="material-icons-sharp">question_answer</span>
                        <h3>FAQ</h3>
                        <p>Find answers to common questions</p>
                    </div>
                </div>
            `
        };

        // ========== PAGE NAVIGATION SYSTEM ==========
        let currentCharts = {};

        function loadPage(pageName) {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = pages[pageName];

            // Update active nav link
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
                if(link.dataset.page === pageName) {
                    link.classList.add('active');
                }
            });

            // Store current page
            localStorage.setItem('currentPage', pageName);

            // Initialize page-specific features
            if(pageName === 'dashboard') {
                initDashboard();
            } else if(pageName === 'settings') {
                initSettings();
            } else if(pageName === 'news') {
                setTimeout(() => {
                    fetchMarketNews();
                    startAutoRefresh();
                }, 100);
            }

            // Scroll to top
            mainContent.scrollTop = 0;
        }

        function initDashboard() {
            // Set today's date
            const dateInput = document.getElementById('date-input');
            if(dateInput) {
                dateInput.value = new Date().toISOString().split('T')[0];
            }

            // Destroy old charts
            Object.values(currentCharts).forEach(chart => chart.destroy());
            currentCharts = {};

            // Create charts
            setTimeout(() => {
                const ctx1 = document.getElementById('stockPerformanceChart');
                if(ctx1) {
                    currentCharts.stock = new Chart(ctx1, {
                        type: 'line',
                        data: {
                            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul'],
                            datasets: [{
                                label: 'AAPL',
                                data: [150, 165, 158, 172, 168, 180, 185],
                                borderColor: '#89c4a1',
                                backgroundColor: 'rgba(137, 196, 161, 0.1)',
                                tension: 0.4,
                                fill: true,
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: { legend: { display: true } }
                        }
                    });
                }

                const ctx2 = document.getElementById('marketTrendsChart');
                if(ctx2) {
                    currentCharts.market = new Chart(ctx2, {
                        type: 'bar',
                        data: {
                            labels: ['Tech', 'Finance', 'Healthcare', 'Energy'],
                            datasets: [{
                                label: 'Bullish',
                                data: [45, 32, 28, 15],
                                backgroundColor: 'rgba(137, 196, 161, 0.8)'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true
                        }
                    });
                }

                const ctx3 = document.getElementById('portfolioChart');
                if(ctx3) {
                    currentCharts.portfolio = new Chart(ctx3, {
                        type: 'doughnut',
                        data: {
                            labels: ['Technology', 'Finance', 'Healthcare', 'Energy'],
                            datasets: [{
                                data: [35, 20, 15, 12],
                                backgroundColor: ['#89c4a1', '#292a2d', '#FF0060', '#ffbb33']
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true
                        }
                    });
                }
            }, 100);
        }

        function initSettings() {
            const savedTheme = localStorage.getItem('theme') || 'default';
            
            document.querySelectorAll('.theme-check').forEach(check => {
                check.style.display = 'none';
            });
            
            const activeCheck = document.getElementById(savedTheme + '-check');
            if(activeCheck) activeCheck.style.display = 'block';

            document.querySelectorAll('.theme-card').forEach(card => {
                if(card.dataset.theme === savedTheme) {
                    card.classList.add('selected');
                }
                
                card.addEventListener('click', function() {
                    const theme = this.dataset.theme;
                    document.body.classList.remove('dark-mode', 'light-mode');
                    
                    if(theme === 'dark') {
                        document.body.classList.add('dark-mode');
                        localStorage.setItem('theme', 'dark');
                    } else if(theme === 'light') {
                        document.body.classList.add('light-mode');
                        localStorage.setItem('theme', 'light');
                    } else {
                        localStorage.setItem('theme', 'default');
                    }
                    
                    document.querySelectorAll('.theme-check').forEach(c => c.style.display = 'none');
                    document.getElementById(theme + '-check').style.display = 'block';
                    
                    document.querySelectorAll('.theme-card').forEach(c => c.classList.remove('selected'));
                    this.classList.add('selected');
                });
            });
        }

        function logout() {
            if(confirm('Are you sure you want to logout?')) {
                localStorage.clear();
                location.reload();
            }
        }



        // ========== MULTI-SOURCE NEWS FEED WITH AUTO-REFRESH ==========
let allNews = [];
let currentFilter = 'all';
let currentSource = 'all';
let autoRefreshEnabled = true;
let autoRefreshInterval = null;

const NEWS_SOURCES = {
    cnbc: {
        name: 'CNBC TV18',
        urls: [
            'https://www.cnbctv18.com/rss/market.xml',
            'https://www.cnbctv18.com/rss/business.xml'
        ],
        icon: 'newspaper'
    },
    moneycontrol: {
        name: 'MoneyControl',
        urls: [
            'https://www.moneycontrol.com/rss/latestnews.xml',
            'https://www.moneycontrol.com/rss/marketoutlook.xml'
        ],
        icon: 'attach_money'
    },
    economictimes: {
        name: 'Economic Times',
        urls: [
            'https://economictimes.indiatimes.com/markets/rssfeeds/1977021501.cms',
            'https://economictimes.indiatimes.com/news/economy/rssfeeds/1373380680.cms'
        ],
        icon: 'trending_up'
    },
    research360: {
        name: 'Research360',
        urls: [
            'https://research360.onelink.me/rss/news.xml'
        ],
        icon: 'analytics'
    }
};

async function fetchMarketNews() {
    const newsContainer = document.getElementById('news-messages-list');
    const loadingDiv = document.getElementById('news-loading');
    
    if(loadingDiv) loadingDiv.style.display = 'block';
    
    try {
        allNews = [];
        
        let sourcesToFetch = [];
        if(currentSource === 'all') {
            sourcesToFetch = Object.keys(NEWS_SOURCES);
        } else {
            sourcesToFetch = [currentSource];
        }
        
        for(let sourceKey of sourcesToFetch) {
            const source = NEWS_SOURCES[sourceKey];
            for(let rssUrl of source.urls) {
                try {
                    const API_URL = `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(rssUrl)}`;
                    const response = await fetch(API_URL);
                    const data = await response.json();
                    
                    if(data.status === 'ok' && data.items) {
                        data.items.forEach(item => {
                            item.sourceName = source.name;
                            item.sourceKey = sourceKey;
                            item.sourceIcon = source.icon;
                        });
                        allNews = allNews.concat(data.items);
                    }
                } catch(error) {
                    console.error(`Error fetching from ${source.name}:`, error);
                }
            }
        }
        
        allNews.sort((a, b) => new Date(b.pubDate) - new Date(a.pubDate));
        allNews = allNews.filter((article, index, self) =>
            index === self.findIndex(t => t.title === article.title)
        );
        
        displayNews(allNews);
        updateLastRefreshTime();
        
        if(loadingDiv) loadingDiv.style.display = 'none';
        
    } catch(error) {
        console.error('Error fetching news:', error);
        if(newsContainer) {
            newsContainer.innerHTML = `
                <div class="news-card error-card">
                    <span class="material-icons-sharp">error</span>
                    <div class="message-content">
                        <h3>Unable to load news</h3>
                        <p>Please check your internet connection and try again</p>
                        <small>Error: ${error.message}</small>
                    </div>
                </div>
            `;
        }
        if(loadingDiv) loadingDiv.style.display = 'none';
    }
}

function displayNews(newsArray) {
    const newsContainer = document.getElementById('news-messages-list');
    if(!newsContainer) return;
    
    if(newsArray.length === 0) {
        newsContainer.innerHTML = `
            <div class="news-card">
                <span class="material-icons-sharp">inbox</span>
                <div class="message-content">
                    <h3>No news available</h3>
                    <p>Try selecting different sources or filters</p>
                </div>
            </div>
        `;
        return;
    }
    
    newsContainer.innerHTML = newsArray.map((article, index) => {
        const timeAgo = getTimeAgo(article.pubDate);
        const category = article.categories && article.categories.length > 0 ? article.categories[0] : 'Market';
        
        const description = article.description ? 
            article.description.replace(/<[^>]*>/g, '').substring(0, 150) + '...' : 
            'Click to read more';
        
        return `
            <div class="news-card ${index < 5 ? 'fresh-news' : ''}" onclick="window.open('${article.link}', '_blank')">
                <div class="news-header">
                    <h3>${article.title}</h3>
                    <small class="news-source-badge">
                        <span class="material-icons-sharp">${article.sourceIcon}</span>
                        ${article.sourceName}
                    </small>
                </div>
                <p>${description}</p>
                <div class="news-meta">
                    <small class="news-time">
                        <span class="material-icons-sharp">schedule</span>
                        ${timeAgo}
                    </small>
                    <span class="category-badge">${category}</span>
                    <span class="read-more">Read more →</span>
                </div>
            </div>
        `;
    }).join('');
}

function changeSource(source) {
    currentSource = source;
    document.querySelectorAll('.source-btn').forEach(btn => btn.classList.remove('active'));
    event.target.closest('.source-btn').classList.add('active');
    fetchMarketNews();
}

function filterNews(category) {
    currentFilter = category;
    document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    let filtered = allNews;
    if(category !== 'all') {
        filtered = allNews.filter(article => {
            const cats = article.categories || [];
            const title = article.title.toLowerCase();
            const desc = (article.description || '').toLowerCase();
            const searchTerm = category.toLowerCase();
            
            return cats.some(cat => cat.toLowerCase().includes(searchTerm)) ||
                   title.includes(searchTerm) ||
                   desc.includes(searchTerm);
        });
    }
    displayNews(filtered);
}

function manualRefresh() {
    fetchMarketNews();
    const btn = event.target.closest('.refresh-btn');
    const icon = btn.querySelector('.material-icons-sharp');
    icon.classList.add('rotating');
    setTimeout(() => icon.classList.remove('rotating'), 1000);
}

function toggleAutoRefresh() {
    autoRefreshEnabled = !autoRefreshEnabled;
    const btn = event.target.closest('.toggle-auto-refresh');
    const icon = btn.querySelector('.material-icons-sharp');
    const text = document.getElementById('auto-refresh-text');
    
    if(autoRefreshEnabled) {
        icon.textContent = 'pause';
        text.textContent = 'Pause Auto-Refresh';
        startAutoRefresh();
    } else {
        icon.textContent = 'play_arrow';
        text.textContent = 'Resume Auto-Refresh';
        stopAutoRefresh();
    }
}

function startAutoRefresh() {
    if(autoRefreshInterval) clearInterval(autoRefreshInterval);
    autoRefreshInterval = setInterval(() => {
        if(autoRefreshEnabled) {
            console.log('Auto-refreshing news...');
            fetchMarketNews();
        }
    }, 300000);
}

function stopAutoRefresh() {
    if(autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
    }
}

function updateLastRefreshTime() {
    const lastUpdateEl = document.getElementById('last-update');
    if(lastUpdateEl) {
        const now = new Date();
        const timeString = now.toLocaleTimeString('en-IN', { 
            hour: '2-digit', 
            minute: '2-digit' 
        });
        lastUpdateEl.textContent = `Last updated: ${timeString}`;
    }
}

function getTimeAgo(dateString) {
    if(!dateString) return 'Recently';
    
    const articleDate = new Date(dateString);
    const now = new Date();
    const diff = Math.floor((now - articleDate) / 1000 / 60);
    
    if(diff < 1) return 'Just now';
    if(diff < 60) return `${diff} minute${diff > 1 ? 's' : ''} ago`;
    if(diff < 1440) return `${Math.floor(diff / 60)} hour${Math.floor(diff / 60) > 1 ? 's' : ''} ago`;
    if(diff < 10080) return `${Math.floor(diff / 1440)} day${Math.floor(diff / 1440) > 1 ? 's' : ''} ago`;
    
    return articleDate.toLocaleDateString('en-IN', { day: 'numeric', month: 'short' });
}



window.addEventListener('beforeunload', () => {
    stopAutoRefresh();
});

        // ========== INITIALIZE APP ==========
        window.addEventListener('DOMContentLoaded', function() {
            // Load saved theme
            const savedTheme = localStorage.getItem('theme');
            if(savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
            } else if(savedTheme === 'light') {
                document.body.classList.add('light-mode');
            }

            // Setup navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    loadPage(this.dataset.page);
                });
            });

            // Load last visited page or dashboard
            const lastPage = localStorage.getItem('currentPage') || 'dashboard';
            loadPage(lastPage);
        });
    </script>

    <!-- Load external script.js file for live data functionality -->
    <script src="script.js"></script>
</body>
</html>
"""
Markstro API - Complete Server with JWT Authentication
Run with: python server.py
"""

from fastapi import FastAPI, Depends, HTTPException, status
from fastapi.middleware.cors import CORSMiddleware
#from fastapi.security import HTTPBearer, HTTPAuthCredentials
from fastapi.security import HTTPBearer
from fastapi.security.http import HTTPAuthorizationCredentials
from pydantic import BaseModel
from typing import Optional
import os
from dotenv import load_dotenv

# Import authentication services
from auth_service import JWTService, UserService

security = HTTPBearer()

async def get_current_user(credentials: HTTPAuthorizationCredentials = Depends(security)):


# Initialize FastAPI app
app = FastAPI(
    title="Markstro API",
    description="Stock Market & News API with JWT Authentication",
    version="1.0.0"
)

# CORS Configuration
origins = [
    "http://localhost:3000",
    "http://localhost:8000",
    "http://127.0.0.1:3000",
    "http://127.0.0.1:8000",
    "*",
]

app.add_middleware(
    CORSMiddleware,
    allow_origins=origins,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# Initialize services
jwt_service = JWTService()
user_service = UserService()
security = HTTPBearer()

# ============================================================================
# Pydantic Models
# ============================================================================

class LoginRequest(BaseModel):
    """Login request model"""
    username: str
    password: str

class LoginResponse(BaseModel):
    """Login response model"""
    access_token: str
    refresh_token: str
    token_type: str
    user: dict

class RegisterRequest(BaseModel):
    """User registration request"""
    username: str
    password: str
    email: str
    full_name: str

class TokenResponse(BaseModel):
    """Token response model"""
    access_token: str
    token_type: str

class UserResponse(BaseModel):
    """User response model"""
    username: str
    email: str
    full_name: str

# ============================================================================
# Dependencies
# ============================================================================

def get_current_user(credentials: HTTPAuthCredentials = Depends(security)) -> str:
    """
    Dependency to extract and verify JWT token from request header
    
    Usage: 
        @app.get("/protected")
        def protected_route(current_user: str = Depends(get_current_user)):
            return {"user": current_user}
    """
    token = credentials.credentials
    username = jwt_service.get_username_from_token(token)
    
    if username is None:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Invalid or expired token",
            headers={"WWW-Authenticate": "Bearer"},
        )
    
    return username

# ============================================================================
# Public Endpoints (No Authentication Required)
# ============================================================================

@app.get("/")
async def root():
    """Root endpoint"""
    return {
        "message": "Markstro API is running!",
        "version": "1.0.0",
        "docs": "http://127.0.0.1:8000/docs",
        "auth": "See POST /api/auth/login"
    }

@app.get("/health")
async def health():
    """Health check endpoint"""
    return {
        "status": "healthy",
        "service": "Markstro API",
        "version": "1.0.0"
    }

# ============================================================================
# Authentication Endpoints
# ============================================================================

@app.post("/api/auth/login", response_model=LoginResponse)
async def login(request: LoginRequest):
    """
    Login endpoint - Get JWT tokens
    
    Test Credentials:
    - username: admin, password: admin123
    - username: demo, password: demo123
    - username: john, password: john123
    """
    # Verify user credentials
    if not user_service.verify_user(request.username, request.password):
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Invalid username or password"
        )
    
    # Get user info
    user = user_service.get_user(request.username)
    
    # Create tokens
    access_token = jwt_service.create_access_token(request.username)
    refresh_token = jwt_service.create_refresh_token(request.username)
    
    return LoginResponse(
        access_token=access_token,
        refresh_token=refresh_token,
        token_type="Bearer",
        user={
            "username": user["username"],
            "email": user["email"],
            "full_name": user["full_name"]
        }
    )

@app.post("/api/auth/register", response_model=LoginResponse)
async def register(request: RegisterRequest):
    """
    Register a new user
    
    Returns JWT tokens after successful registration
    """
    # Check if user already exists
    if user_service.user_exists(request.username):
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail="Username already exists"
        )
    
    # Create new user
    user_service.create_user(
        username=request.username,
        password=request.password,
        email=request.email,
        full_name=request.full_name
    )
    
    # Get created user
    user = user_service.get_user(request.username)
    
    # Create tokens
    access_token = jwt_service.create_access_token(request.username)
    refresh_token = jwt_service.create_refresh_token(request.username)
    
    return LoginResponse(
        access_token=access_token,
        refresh_token=refresh_token,
        token_type="Bearer",
        user={
            "username": user["username"],
            "email": user["email"],
            "full_name": user["full_name"]
        }
    )

@app.post("/api/auth/refresh", response_model=TokenResponse)
async def refresh_token(credentials: HTTPAuthCredentials = Depends(security)):
    """
    Refresh access token using refresh token
    """
    token = credentials.credentials
    payload = jwt_service.verify_token(token)
    
    if not payload or payload.get("type") != "refresh":
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Invalid refresh token"
        )
    
    username = payload.get("sub")
    new_access_token = jwt_service.create_access_token(username)
    
    return TokenResponse(
        access_token=new_access_token,
        token_type="Bearer"
    )

# ============================================================================
# Protected Endpoints (Requires Authentication)
# ============================================================================

@app.get("/api/auth/me", response_model=UserResponse)
async def get_current_user_info(current_user: str = Depends(get_current_user)):
    """
    Get current user information (Protected)
    
    Required: Bearer token in Authorization header
    """
    user = user_service.get_user(current_user)
    return UserResponse(
        username=user["username"],
        email=user["email"],
        full_name=user["full_name"]
    )

@app.get("/api/auth/verify")
async def verify_token(current_user: str = Depends(get_current_user)):
    """
    Verify if token is valid (Protected)
    """
    return {
        "valid": True,
        "username": current_user,
        "message": "Token is valid"
    }

# ============================================================================
# Stock Endpoints (Protected)
# ============================================================================

@app.get("/api/stock/quote/{symbol}")
async def get_stock_quote(symbol: str, current_user: str = Depends(get_current_user)):
    """
    Get stock quote (Protected - Requires Authentication)
    
    Example: GET /api/stock/quote/AAPL
    Authorization: Bearer <your_token>
    """
    return {
        "symbol": symbol.upper(),
        "price": 150.25,
        "change": 2.5,
        "change_percent": 1.7,
        "requested_by": current_user,
        "message": "Endpoint ready for implementation"
    }

@app.get("/api/stock/search")
async def search_stocks(q: str, current_user: str = Depends(get_current_user)):
    """
    Search for stocks (Protected)
    
    Example: GET /api/stock/search?q=apple
    Authorization: Bearer <your_token>
    """
    return {
        "query": q,
        "results": [
            {"symbol": "AAPL", "name": "Apple Inc."},
            {"symbol": "APPL", "name": "AppLovin Corporation"}
        ],
        "requested_by": current_user
    }

# ============================================================================
# News Endpoints (Protected)
# ============================================================================

@app.get("/api/news")
async def get_news(current_user: str = Depends(get_current_user)):
    """
    Get latest news (Protected)
    
    Authorization: Bearer <your_token>
    """
    return {
        "news": [],
        "total": 0,
        "requested_by": current_user,
        "message": "News endpoint ready for implementation"
    }

@app.get("/api/news/search")
async def search_news(q: str, current_user: str = Depends(get_current_user)):
    """
    Search news (Protected)
    
    Example: GET /api/news/search?q=stocks
    Authorization: Bearer <your_token>
    """
    return {
        "query": q,
        "results": [],
        "requested_by": current_user
    }

# ============================================================================
# Error Handlers
# ============================================================================

@app.exception_handler(HTTPException)
async def http_exception_handler(request, exc):
    return {
        "error": exc.detail,
        "status_code": exc.status_code
    }

# ============================================================================
# Main
# ============================================================================

if __name__ == "__main__":
    import uvicorn
    
    print("\n" + "="*70)
    print("üöÄ MARKSTRO API - Starting with JWT Authentication")
    print("="*70)
    print("\nüìö API Documentation:")
    print("   Interactive Docs: http://127.0.0.1:8000/docs")
    print("   ReDoc: http://127.0.0.1:8000/redoc")
    print("\nüîë Test Credentials:")
    print("   Username: admin | Password: admin123")
    print("   Username: demo  | Password: demo123")
    print("   Username: john  | Password: john123")
    print("\nüìù Quick Start:")
    print("   1. POST /api/auth/login with username & password")
    print("   2. Copy the 'access_token' from response")
    print("   3. Add header: Authorization: Bearer <your_token>")
    print("   4. Access protected endpoints")
    print("\n" + "="*70 + "\n")
    
    uvicorn.run(
        app,
        host="127.0.0.1",
        port=8000,
        reload=True,
        log_level="info"
    )
       pass